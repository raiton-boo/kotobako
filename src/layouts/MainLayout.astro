---
/**
 * ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 *
 * ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: æ—¢å­˜ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
 * ãƒ¢ãƒã‚¤ãƒ«/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ: ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒœã‚¿ãƒ³ã‚’çµ±åˆ
 */
import Layout from './Layout.astro';
import FavoriteNotice from '../components/FavoriteNotice.astro';
import Footer from '../components/Footer.astro';
import categoriesData from '../data/categories.json';
import type { CategoriesData } from '../types';

const data = categoriesData as CategoriesData;

interface Props {
  title: string;
  description?: string;
  ogImage?: string;
  showFavoriteNotice?: boolean;
  currentCategory?: string;
}

const { title, description, ogImage, showFavoriteNotice = true, currentCategory } = Astro.props;

// ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ãƒ‘ã‚¹ã‚’å–å¾—
const currentPath = Astro.url.pathname;
const isHome = currentPath === '/kotobako/' || currentPath === '/kotobako';
const isFavorites = currentPath === '/kotobako/favorites' || currentPath === '/kotobako/favorites/';

// ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼æƒ…å ±ã‚’å–å¾—
const currentCategoryData = currentCategory 
  ? data.categories.find(cat => cat.id === currentCategory)
  : null;
---

<Layout title={title} description={description} ogImage={ogImage}>
  <style is:global>
    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .progress-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, rgba(167, 139, 250, 0.3) 0%, transparent 0%);
      border-radius: 1rem;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 1;
    }

    .progress-overlay.active {
      opacity: 1;
    }

    /* ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆé–‹ã„ãŸæ™‚ã«èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
    body.sheet-open {
      overflow: hidden;
      position: fixed;
      width: 100%;
    }
  </style>

  <!-- ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ1024pxæœªæº€ï¼‰ -->
  <header class="lg:hidden bg-white shadow-md sticky top-0 z-30">
    <div class="px-4 py-3">
      <div class="flex justify-between items-center">
        <!-- ãƒ­ã‚´ -->
        <a href="/kotobako/" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
          <img src="/kotobako/kotobako_icon.png" alt="ã“ã¨ã°ç®±ã‚¢ã‚¤ã‚³ãƒ³" class="w-10 h-10 object-contain" />
          <h1 class="text-lg font-bold text-gray-800">ã“ã¨ã°ç®±</h1>
        </a>

        <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒœã‚¿ãƒ³ -->
        <button
          id="mobile-category-btn"
          class:list={[
            'relative flex items-center gap-2 px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 font-bold text-sm',
            currentCategory ? 'bg-purple-600 text-white' : (isFavorites ? 'bg-pink-600 text-white' : 'bg-purple-500 text-white')
          ]}
          aria-label="ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠ"
        >
          <span class="text-lg">ğŸ“</span>
          <span>
            {currentCategoryData ? currentCategoryData.name : (isFavorites ? 'ãŠæ°—ã«å…¥ã‚Š' : 'ã‚«ãƒ†ã‚´ãƒªãƒ¼')}
          </span>
          <!-- ãŠæ°—ã«å…¥ã‚Šãƒãƒƒã‚¸ï¼ˆå³ä¸‹ï¼‰ -->
          <span
            id="mobile-fav-badge"
            class="absolute -bottom-1 -right-1 bg-red-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold shadow-lg"
            style="display: none;"
          >
            0
          </span>
        </button>
      </div>
    </div>
  </header>

  <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—å°‚ç”¨ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ1024pxä»¥ä¸Šï¼‰ -->
  <header class="hidden lg:block bg-white shadow-sm sticky top-0 z-40 transition-colors duration-300 border-b-2 border-gray-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <a href="/kotobako/" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
          <img src="/kotobako/kotobako_icon.png" alt="ã“ã¨ã°ç®±ã‚¢ã‚¤ã‚³ãƒ³" class="w-16 h-16 object-contain" />
          <div class="leading-tight">
            <h1 class="text-2xl font-bold text-gray-800">ã“ã¨ã°ç®±</h1>
            <p class="text-sm text-gray-400">ã‚»ãƒªãƒ•ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</p>
          </div>
        </a>

        <nav class="flex items-center gap-3">
          <a href="/kotobako/" class="flex items-center gap-2 px-3 py-2 rounded-full hover:bg-purple-50 transition-all duration-200 text-gray-600" aria-label="ãƒ›ãƒ¼ãƒ ã¸ç§»å‹•">
            <span class="hidden sm:inline">ãƒ›ãƒ¼ãƒ </span>
          </a>
        </nav>
      </div>
    </div>
  </header>

  <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆ -->
  <div
    id="mobile-category-sheet"
    class="lg:hidden fixed inset-0 z-50 opacity-0 invisible transition-opacity duration-300"
  >
    <div
      id="mobile-overlay"
      class="absolute inset-0 bg-black bg-opacity-50"
    ></div>

    <div
      id="mobile-sheet-content"
      class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300"
    >
      <div class="flex justify-center pt-3 pb-2">
        <div class="w-12 h-1 bg-gray-300 rounded-full"></div>
      </div>

      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="font-bold text-xl text-gray-800">ã‚«ãƒ†ã‚´ãƒªãƒ¼</h3>
      </div>

      <div class="max-h-[60vh] overflow-y-auto pb-6">
        <!-- ãƒ›ãƒ¼ãƒ ãƒªãƒ³ã‚¯ -->
        <a
          href="/kotobako/"
          class:list={[
            'block px-6 py-5 hover:bg-purple-50 active:bg-purple-100 transition-colors duration-200',
            isHome && 'bg-purple-200 shadow-inner'
          ]}
        >
          <div class="flex items-center gap-4">
            <span class="text-3xl">ğŸ </span>
            <div class="flex-1">
              <div class="font-bold text-lg text-gray-800">ãƒ›ãƒ¼ãƒ </div>
              <div class="text-sm text-gray-500">ãƒ©ãƒ³ãƒ€ãƒ ãªã‚»ãƒªãƒ•ã‚’è¡¨ç¤º</div>
            </div>
            {isHome && (
              <span class="text-purple-600 text-xl font-bold">âœ“</span>
            )}
          </div>
        </a>

        <!-- ãŠæ°—ã«å…¥ã‚Šãƒªãƒ³ã‚¯ -->
        <a
          href="/kotobako/favorites"
          class:list={[
            'block px-6 py-5 hover:bg-pink-50 active:bg-pink-100 transition-colors duration-200 mb-2',
            isFavorites && 'bg-pink-200 shadow-inner'
          ]}
        >
          <div class="flex items-center gap-4">
            <span class="text-3xl">â¤ï¸</span>
            <div class="flex-1">
              <div class="font-bold text-lg text-gray-800">ãŠæ°—ã«å…¥ã‚Š</div>
              <div class="text-sm text-gray-500">ä¿å­˜ã—ãŸã‚»ãƒªãƒ•ä¸€è¦§</div>
            </div>
            <div class="flex items-center gap-2">
              <!-- ãŠæ°—ã«å…¥ã‚Šä»¶æ•° -->
              <span
                id="mobile-sheet-fav-count"
                class="bg-pink-500 text-white text-sm px-2.5 py-1 rounded-full font-bold shadow-md"
                style="display: none;"
              >
                0
              </span>
              {isFavorites && (
                <span class="text-pink-600 text-xl font-bold">âœ“</span>
              )}
            </div>
          </div>
        </a>

        <!-- åŒºåˆ‡ã‚Šç·š -->
        <div class="border-t border-gray-200 mb-2"></div>

        <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ -->
        {data.categories.map((category) => {
          const isCurrent = currentCategory === category.id;
          return (
            <a
              href={`/kotobako/category/${category.id}`}
              class:list={[
                'block px-6 py-5 hover:bg-purple-50 active:bg-purple-100 transition-colors duration-200',
                isCurrent && 'bg-purple-200 shadow-inner'
              ]}
            >
              <div class="flex items-center gap-4">
                <span class="text-3xl">{category.icon}</span>
                <div class="flex-1">
                  <div class="font-bold text-lg text-gray-800">{category.name}</div>
                  <div class="text-sm text-gray-500">{category.serifu.length}ä»¶ã®ã‚»ãƒªãƒ•</div>
                </div>
                {isCurrent && (
                  <span class="text-purple-600 text-xl font-bold">âœ“</span>
                )}
              </div>
            </a>
          );
        })}
      </div>
    </div>
  </div>

  <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆ1024pxä»¥ä¸Šï¼‰ -->
  {showFavoriteNotice && <FavoriteNotice />}

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="lg:flex lg:gap-8">
      <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒŠãƒ“ -->
      <aside class="hidden lg:block w-64 shrink-0">
        <nav class="sticky top-24 space-y-2">
          <!-- ãƒ›ãƒ¼ãƒ ãƒªãƒ³ã‚¯ -->
          <a
            href="/kotobako/"
            class:list={[
              'block px-4 py-3 rounded-xl hover:bg-purple-100 transition-colors duration-200',
              isHome && 'bg-purple-200 shadow-md ring-2 ring-purple-300'
            ]}
          >
            <div class="flex items-center gap-3">
              <span class="text-2xl">ğŸ </span>
              <div class="flex-1">
                <div class="font-bold text-gray-800">ãƒ›ãƒ¼ãƒ </div>
                <div class="text-xs text-gray-500">ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º</div>
              </div>
              {isHome && (
                <span class="text-purple-600 text-lg font-bold">âœ“</span>
              )}
            </div>
          </a>

          <!-- ãŠæ°—ã«å…¥ã‚Šãƒªãƒ³ã‚¯ -->
          <a
            href="/kotobako/favorites"
            class:list={[
              'block px-4 py-3 rounded-xl hover:bg-pink-100 transition-colors duration-200 mb-4',
              isFavorites && 'bg-pink-200 shadow-md ring-2 ring-pink-300'
            ]}
          >
            <div class="flex items-center gap-3">
              <span class="text-2xl">â¤ï¸</span>
              <div class="flex-1">
                <div class="font-bold text-gray-800">ãŠæ°—ã«å…¥ã‚Š</div>
                <div class="text-xs text-gray-500">ä¿å­˜ã—ãŸã‚»ãƒªãƒ•</div>
              </div>
              <div class="flex items-center gap-2">
                <!-- ãŠæ°—ã«å…¥ã‚Šä»¶æ•° -->
                <span
                  id="desktop-fav-count"
                  class="bg-pink-500 text-white text-xs px-2 py-0.5 rounded-full font-bold shadow-md"
                  style="display: none;"
                >
                  0
                </span>
                {isFavorites && (
                  <span class="text-pink-600 text-lg font-bold">âœ“</span>
                )}
              </div>
            </div>
          </a>

          <!-- åŒºåˆ‡ã‚Šç·š -->
          <div class="border-t border-gray-200 my-4"></div>

          <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ -->
          {data.categories.map((category) => {
            const isCurrent = currentCategory === category.id;
            return (
              <a
                href={`/kotobako/category/${category.id}`}
                class:list={[
                  'block px-4 py-3 rounded-xl transition-colors duration-200',
                  isCurrent 
                    ? 'bg-purple-200 shadow-md ring-2 ring-purple-300'
                    : 'hover:bg-purple-100'
                ]}
              >
                <div class="flex items-center gap-3">
                  <span class="text-2xl">{category.icon}</span>
                  <div class="flex-1">
                    <div class="font-bold text-gray-800">{category.name}</div>
                    <div class="text-xs text-gray-500">{category.serifu.length}ä»¶</div>
                  </div>
                  {isCurrent && (
                    <span class="text-purple-600 text-lg font-bold">âœ“</span>
                  )}
                </div>
              </a>
            );
          })}
        </nav>
      </aside>

      <main class="flex-1 min-w-0">
        <slot />
      </main>
    </div>
  </div>

  <Footer />

  <script>
    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆ
    const mobileBtn = document.getElementById('mobile-category-btn');
    const mobileSheet = document.getElementById('mobile-category-sheet');
    const mobileOverlay = document.getElementById('mobile-overlay');
    const mobileContent = document.getElementById('mobile-sheet-content');

    let scrollPosition = 0;

    function openMobileSheet() {
      if (mobileSheet && mobileContent) {
        // ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜
        scrollPosition = window.pageYOffset || document.documentElement.scrollTop;

        // èƒŒæ™¯ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²æ­¢
        document.body.classList.add('sheet-open');
        document.body.style.top = `-${scrollPosition}px`;

        // ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆã‚’è¡¨ç¤º
        mobileSheet.classList.remove('opacity-0', 'invisible');
        setTimeout(() => {
          mobileContent?.classList.remove('translate-y-full');
        }, 10);
      }
    }

    function closeMobileSheet() {
      if (mobileSheet && mobileContent) {
        // ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹
        mobileContent.classList.add('translate-y-full');

        setTimeout(() => {
          mobileSheet.classList.add('opacity-0', 'invisible');

          // èƒŒæ™¯ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
          document.body.classList.remove('sheet-open');
          document.body.style.top = '';
          window.scrollTo(0, scrollPosition);
        }, 300);
      }
    }

    if (mobileBtn) {
      mobileBtn.addEventListener('click', openMobileSheet);
    }

    if (mobileOverlay) {
      mobileOverlay.addEventListener('click', closeMobileSheet);
    }

    // ã‚¹ãƒ¯ã‚¤ãƒ—ã§é–‰ã˜ã‚‹ï¼ˆæ”¹å–„ç‰ˆï¼‰
    let startY = 0;
    let currentY = 0;
    let isDragging = false;

    if (mobileContent) {
      mobileContent.addEventListener('touchstart', (e) => {
        const target = e.target as HTMLElement;
        const scrollContainer = mobileContent.querySelector('.max-h-\\[60vh\\]');

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒŠã®ä¸€ç•ªä¸Šã«ã„ã‚‹å ´åˆã®ã¿ãƒ‰ãƒ©ãƒƒã‚°ã‚’æœ‰åŠ¹åŒ–
        if (scrollContainer && scrollContainer.scrollTop === 0) {
          startY = e.touches[0].clientY;
          isDragging = true;
        }
      });

      mobileContent.addEventListener('touchmove', (e) => {
        if (!isDragging) return;

        currentY = e.touches[0].clientY;
        const diff = currentY - startY;

        // ä¸‹æ–¹å‘ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã®ã¿è¨±å¯
        if (diff > 0) {
          e.preventDefault();
          mobileContent.style.transform = `translateY(${diff}px)`;
        }
      });

      mobileContent.addEventListener('touchend', () => {
        if (!isDragging) return;

        const diff = currentY - startY;

        if (diff > 100) {
          closeMobileSheet();
        } else {
          mobileContent.style.transform = '';
        }

        isDragging = false;
      });
    }

    // ãŠæ°—ã«å…¥ã‚Šä»¶æ•°ã®æ›´æ–°
    function updateFavoriteCount() {
      try {
        // é…åˆ—å½¢å¼ã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã®ä¸¡æ–¹ã«å¯¾å¿œ
        const favoritesRaw = localStorage.getItem('kotobako-favorites') || '[]';
        let count = 0;

        try {
          const parsed = JSON.parse(favoritesRaw);
          if (Array.isArray(parsed)) {
            count = parsed.length;
          } else if (typeof parsed === 'object' && parsed !== null) {
            count = Object.keys(parsed).length;
          }
        } catch (e) {
          console.error('Failed to parse favorites:', e);
        }

        console.log('Favorites count:', count, 'Raw:', favoritesRaw);

        // ãƒ¢ãƒã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒãƒƒã‚¸ï¼ˆå³ä¸‹ï¼‰
        const mobileBadge = document.getElementById('mobile-fav-badge');
        if (mobileBadge) {
          mobileBadge.textContent = count.toString();
          mobileBadge.style.display = count > 0 ? 'flex' : 'none';
        }

        // ãƒ¢ãƒã‚¤ãƒ«ã‚·ãƒ¼ãƒˆã®ãƒãƒƒã‚¸ï¼ˆãŠæ°—ã«å…¥ã‚Šè¡Œï¼‰
        const sheetBadge = document.getElementById('mobile-sheet-fav-count');
        if (sheetBadge) {
          sheetBadge.textContent = count.toString();
          sheetBadge.style.display = count > 0 ? 'inline-block' : 'none';
        }

        // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ãƒãƒƒã‚¸
        const desktopBadge = document.getElementById('desktop-fav-count');
        if (desktopBadge) {
          desktopBadge.textContent = count.toString();
          desktopBadge.style.display = count > 0 ? 'inline-block' : 'none';
        }
      } catch (error) {
        console.error('Failed to update favorite count:', error);
      }
    }

    // åˆæœŸè¡¨ç¤º
    updateFavoriteCount();

    // storageã‚¤ãƒ™ãƒ³ãƒˆã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
    window.addEventListener('storage', updateFavoriteCount);

    // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚æ›´æ–°
    window.addEventListener('favoritesUpdated', updateFavoriteCount);

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚‚å®Ÿè¡Œ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateFavoriteCount);
    } else {
      updateFavoriteCount();
    }
  </script>
</Layout>