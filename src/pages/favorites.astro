---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import CategoryNav from '../components/CategoryNav.astro';
import SearchBar from '../components/SearchBar.astro';
import SortMenu from '../components/SortMenu.astro';
import FavoriteNotice from '../components/FavoriteNotice.astro';
import Footer from '../components/Footer.astro';
import categoriesData from '../data/categories.json';

const title = 'ãŠæ°—ã«å…¥ã‚Š | ã“ã¨ã°ç®±';
const description = 'ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã—ãŸã‚»ãƒªãƒ•ä¸€è¦§';

interface Serifu {
  id: string;
  text: string;
  featured: boolean;
  createdAt: string;
}

interface Category {
  id: string;
  name: string;
  icon: string;
  description: string;
  serifu: Serifu[];
}

interface CategoriesData {
  categories: Category[];
}

const data = categoriesData as CategoriesData;

const allSerifu = data.categories.flatMap((category) =>
  category.serifu.map((s) => ({
    ...s,
    category: category.id,
  }))
);
---

<Layout title={title} description={description}>
  <style is:global>
    .progress-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, rgba(167, 139, 250, 0.3) 0%, transparent 0%);
      border-radius: 1rem;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 1;
    }

    .progress-overlay.active {
      opacity: 1;
    }
  </style>

  <FavoriteNotice />
  <Header />
  
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex gap-8">
      <CategoryNav />
      
      <main class="flex-1 min-w-0">
        <nav class="mb-6 text-sm text-gray-400">
          <a href="/kotobako" class="hover:underline">ãƒ›ãƒ¼ãƒ </a>
          <span class="mx-2">/</span>
          <span class="text-gray-600">ğŸ’– ãŠæ°—ã«å…¥ã‚Š</span>
        </nav>

        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-800 mb-2">
            ğŸ’– ãŠæ°—ã«å…¥ã‚Š
          </h1>
          <p class="text-lg text-gray-600">
            ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã—ãŸã‚»ãƒªãƒ•ä¸€è¦§
          </p>
          <p id="favorite-count" class="text-sm mt-2 text-gray-400">
            å…¨ 0 ä»¶
          </p>
        </div>

        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <div class="flex-1">
            <SearchBar />
          </div>
          <div>
            <select
              id="sort-select"
              class="px-4 py-3 border border-gray-300 rounded-full text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all duration-200"
            >
              <option value="added-newest">è¿½åŠ ã—ãŸæ–°ã—ã„é †</option>
              <option value="added-oldest">è¿½åŠ ã—ãŸå¤ã„é †</option>
              <option value="newest">ä½œæˆæ—¥ãŒæ–°ã—ã„é †</option>
              <option value="oldest">ä½œæˆæ—¥ãŒå¤ã„é †</option>
              <option value="featured">ãŠã™ã™ã‚é †</option>
            </select>
          </div>
        </div>

        <div id="serifu-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
        </div>

        <div id="empty-state" class="hidden text-center py-16">
          <p class="text-6xl mb-4">ğŸ’”</p>
          <p class="text-xl font-bold text-gray-600 mb-2">ãŠæ°—ã«å…¥ã‚ŠãŒã‚ã‚Šã¾ã›ã‚“</p>
          <p class="text-gray-400 mb-6">ã‚»ãƒªãƒ•ã‚«ãƒ¼ãƒ‰ã® â¤ï¸ ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ã¾ã—ã‚‡ã†</p>
          <a href="/kotobako" class="inline-block px-6 py-3 bg-purple-400 text-white rounded-full font-bold hover:bg-purple-500 transition-all duration-200">
            ã‚»ãƒªãƒ•ã‚’æ¢ã™
          </a>
        </div>
      </main>
    </div>
  </div>
  
  <Footer />
</Layout>

<script define:vars={{ allSerifu }} is:inline>
  // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼šæ—§å½¢å¼ã‹ã‚‰æ–°å½¢å¼ã¸å¤‰æ›
  let favoritesData = JSON.parse(localStorage.getItem('favoritesData') || '{}');
  const oldFavorites = JSON.parse(localStorage.getItem('favorites') || '[]');
  
  // æ—§å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã€æ–°å½¢å¼ãŒç©ºã®å ´åˆã¯ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  if (oldFavorites.length > 0 && Object.keys(favoritesData).length === 0) {
    oldFavorites.forEach(id => {
      favoritesData[id] = Date.now();
    });
    localStorage.setItem('favoritesData', JSON.stringify(favoritesData));
  }
  
  const favorites = Object.keys(favoritesData);
  
  const serifuList = document.getElementById('serifu-list');
  const emptyState = document.getElementById('empty-state');
  const favoriteCount = document.getElementById('favorite-count');

  const favoriteSerifuList = allSerifu
    .filter((serifu) => favorites.includes(serifu.id))
    .map((serifu) => ({
      ...serifu,
      addedAt: favoritesData[serifu.id] || Date.now()
    }));

  if (favoriteSerifuList.length === 0) {
    emptyState?.classList.remove('hidden');
    if (favoriteCount) {
      favoriteCount.textContent = 'å…¨ 0 ä»¶';
    }
  } else {
    if (favoriteCount) {
      favoriteCount.textContent = `å…¨ ${favoriteSerifuList.length} ä»¶`;
    }

    favoriteSerifuList.forEach((serifu) => {
      const wrapper = document.createElement('div');
      wrapper.setAttribute('data-text', serifu.text.toLowerCase());
      wrapper.setAttribute('data-date', serifu.createdAt);
      wrapper.setAttribute('data-added', String(serifu.addedAt));
      wrapper.setAttribute('data-featured', String(serifu.featured));
      wrapper.className = 'transition-all duration-300';

      const categoryNames = {
        'batsu-game': 'ç½°ã‚²ãƒ¼ãƒ ',
        'kokuhaku': 'å‘Šç™½',
        'haishin': 'é…ä¿¡',
        'chuunibyou': 'å¨äºŒç—…'
      };
      const categoryName = categoryNames[serifu.category] || serifu.category;
      const displayId = `${categoryName} No.${serifu.id.split('-').pop()}`;
      const formattedDate = serifu.createdAt.replace(/-/g, '/');

      wrapper.innerHTML = `
        <div 
          id="serifu-${serifu.id}"
          class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all duration-300 p-8 relative transform hover:-translate-y-1 cursor-pointer select-none overflow-hidden"
          data-id="${serifu.id}"
          data-category="${serifu.category}"
          style="height: 280px;"
        >
          <div class="progress-overlay"></div>
          
          ${serifu.featured ? `
            <span class="absolute top-4 right-4 bg-yellow-400 text-yellow-900 text-xs px-3 py-1 rounded-full font-bold pointer-events-none" style="z-index: 2;">
              â­ ãŠã™ã™ã‚
            </span>
          ` : ''}
          
          <div class="absolute inset-0 flex items-center justify-center p-8 pointer-events-none" style="padding-bottom: 80px; z-index: 2;">
            <p class="font-serifu text-3xl md:text-4xl text-center leading-relaxed text-gray-800">
              ${serifu.text}
            </p>
          </div>
          
          <div class="absolute bottom-0 left-0 right-0 flex justify-between items-center p-8 pt-4 border-t border-gray-200 pointer-events-none" style="z-index: 2;">
            <div class="flex flex-col gap-1">
              <span class="text-sm font-bold text-gray-400">
                ${displayId}
              </span>
              <span class="text-xs text-gray-400">
                Created at ${formattedDate}
              </span>
            </div>
            
            <div class="flex gap-2 pointer-events-auto">
              <button
                class="favorite-btn p-2 rounded-full hover:bg-gray-100 transition-all duration-200"
                aria-label="ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ "
                data-serifu-id="${serifu.id}"
              >
                ğŸ’–
              </button>
              
              <button
                class="copy-btn p-2 rounded-full hover:bg-gray-100 transition-all duration-200"
                aria-label="ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼"
                data-serifu-id="${serifu.id}"
                data-category="${serifu.category}"
              >
                ğŸ”—
              </button>
            </div>
          </div>
        </div>
      `;
      
      serifuList?.appendChild(wrapper);
    });

    setupLongPress();
  }

  // æ¤œç´¢æ©Ÿèƒ½
  const searchInput = document.getElementById('search-input');
  searchInput?.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    const items = serifuList?.querySelectorAll('[data-text]');
    
    items?.forEach((item) => {
      const text = item.getAttribute('data-text') || '';
      item.style.display = text.includes(query) ? 'block' : 'none';
    });
  });

  // ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
  const sortSelect = document.getElementById('sort-select');
  sortSelect?.addEventListener('change', (e) => {
    const sortType = e.target.value;
    const items = Array.from(serifuList?.querySelectorAll('[data-date]') || []);
    
    items.sort((a, b) => {
      if (sortType === 'added-newest') {
        return Number(b.getAttribute('data-added')) - Number(a.getAttribute('data-added'));
      } else if (sortType === 'added-oldest') {
        return Number(a.getAttribute('data-added')) - Number(b.getAttribute('data-added'));
      } else if (sortType === 'newest') {
        return (b.getAttribute('data-date') || '').localeCompare(a.getAttribute('data-date') || '');
      } else if (sortType === 'oldest') {
        return (a.getAttribute('data-date') || '').localeCompare(b.getAttribute('data-date') || '');
      } else if (sortType === 'featured') {
        const aFeatured = a.getAttribute('data-featured') === 'true' ? 1 : 0;
        const bFeatured = b.getAttribute('data-featured') === 'true' ? 1 : 0;
        return bFeatured - aFeatured;
      }
      return 0;
    });
    
    items.forEach(item => serifuList?.appendChild(item));
  });

  // é•·æŠ¼ã—æ©Ÿèƒ½
  let progressInterval = null;
  let progress = 0;

  function setupLongPress() {
    const cards = document.querySelectorAll('[data-id]');
    
    cards.forEach((card) => {
      const overlay = card.querySelector('.progress-overlay');
      const category = card.getAttribute('data-category');
      const id = card.getAttribute('data-id');

      const startPress = (e) => {
        if (e.target.closest('button')) return;
        
        progress = 0;
        overlay?.classList.add('active');
        
        progressInterval = setInterval(() => {
          progress += 2;
          if (overlay) {
            overlay.style.background = `linear-gradient(90deg, rgba(167, 139, 250, 0.3) ${progress}%, transparent ${progress}%)`;
          }
          
          if (progress >= 100) {
            clearInterval(progressInterval);
            sessionStorage.setItem('scrollToSerifu', id);
            window.location.href = `/kotobako/category/${category}#serifu-${id}`;
          }
        }, 20);
      };

      const endPress = () => {
        if (progressInterval) clearInterval(progressInterval);
        progress = 0;
        overlay?.classList.remove('active');
        if (overlay) {
          overlay.style.background = 'linear-gradient(90deg, rgba(167, 139, 250, 0.3) 0%, transparent 0%)';
        }
      };

      card.addEventListener('mousedown', startPress);
      card.addEventListener('touchstart', startPress);
      card.addEventListener('mouseup', endPress);
      card.addEventListener('mouseleave', endPress);
      card.addEventListener('touchend', endPress);
      card.addEventListener('touchcancel', endPress);
    });
  }

  // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
  function showToast(icon, message, color) {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const existingToasts = container.querySelectorAll('.toast-item');
    if (existingToasts.length >= 3) {
      existingToasts[0].remove();
    }

    const toast = document.createElement('div');
    toast.className = 'toast-item';
    toast.style.backgroundColor = color;
    toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;

    container.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 2000);
  }

  // ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³
  document.querySelectorAll('.favorite-btn').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const id = btn.getAttribute('data-serifu-id');
      
      const favoritesData = JSON.parse(localStorage.getItem('favoritesData') || '{}');
      
      if (favoritesData[id]) {
        delete favoritesData[id];
        btn.textContent = 'â¤ï¸';
        showToast('ğŸ’”', 'ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ', '#ef4444');
        
        const wrapper = btn.closest('[data-text]');
        if (wrapper) {
          wrapper.style.transition = 'all 0.3s ease';
          wrapper.style.transform = 'scale(0.8)';
          wrapper.style.opacity = '0';
          
          setTimeout(() => {
            wrapper.remove();
            
            const remainingCards = serifuList.querySelectorAll('[data-text]');
            if (favoriteCount) {
              favoriteCount.textContent = `å…¨ ${remainingCards.length} ä»¶`;
            }
            
            if (remainingCards.length === 0) {
              serifuList?.classList.add('hidden');
              emptyState?.classList.remove('hidden');
            }
          }, 300);
        }
      } else {
        favoritesData[id] = Date.now();
        btn.textContent = 'ğŸ’–';
        showToast('ğŸ’–', 'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ã¾ã—ãŸ', '#a855f7');
      }
      
      localStorage.setItem('favoritesData', JSON.stringify(favoritesData));
      localStorage.setItem('favorites', JSON.stringify(Object.keys(favoritesData)));
    });
  });

  // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
  document.querySelectorAll('.copy-btn').forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const id = btn.getAttribute('data-serifu-id');
      const category = btn.getAttribute('data-category');
      const url = `${window.location.origin}/kotobako/category/${category}#serifu-${id}`;
      
      try {
        await navigator.clipboard.writeText(url);
        btn.textContent = 'âœ…';
        showToast('ğŸ”—', 'ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', '#10b981');
        setTimeout(() => btn.textContent = 'ğŸ”—', 2000);
      } catch (err) {
        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });
  });
</script>