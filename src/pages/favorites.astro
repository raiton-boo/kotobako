---
/**
 * ãŠæ°—ã«å…¥ã‚Šãƒšãƒ¼ã‚¸
 * 
 * ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã—ãŸã‚»ãƒªãƒ•ã‚’ä¸€è¦§è¡¨ç¤º
 */
import MainLayout from '../layouts/MainLayout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import SearchBar from '../components/SearchBar.astro';
import SortMenu from '../components/SortMenu.astro';
import categoriesData from '../data/categories.json';
import type { Serifu, Category, CategoriesData } from '../types';

const title = 'ãŠæ°—ã«å…¥ã‚Š | ã“ã¨ã°ç®±';
const description = 'ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã—ãŸã‚»ãƒªãƒ•ä¸€è¦§';

const data = categoriesData as CategoriesData;

// å…¨ã‚»ãƒªãƒ•ã‚’ã‚«ãƒ†ã‚´ãƒªãƒ¼æƒ…å ±ä»˜ãã§å–å¾—
const allSerifu: Array<Serifu & { category: string }> = [];

data.categories.forEach((category: Category) => {
  category.serifu.forEach((serifu: Serifu) => {
    allSerifu.push({
      ...serifu,
      category: category.id,
    });
  });
});
---

<MainLayout title={title} description={description}>
  <!-- ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ -->
  <Breadcrumb 
    items={[
      { label: 'ãƒ›ãƒ¼ãƒ ', href: '/kotobako', icon: 'ğŸ ' },
      { label: 'ãŠæ°—ã«å…¥ã‚Š', icon: 'ğŸ’–' }
    ]} 
  />

  <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="mb-8">
    <div class="flex items-center justify-between flex-wrap gap-4">
      <div>
        <h1 class="text-4xl font-bold mb-3 text-gray-800">
          ğŸ’– ãŠæ°—ã«å…¥ã‚Š
        </h1>
        <p class="text-lg text-gray-600 mb-2">
          ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã—ãŸã‚»ãƒªãƒ•ä¸€è¦§
        </p>
        <p id="favorite-count" class="text-sm text-gray-400">
          å…¨ 0 ä»¶
        </p>
      </div>
      
      <div class="flex gap-3">
        <button
          id="show-notice-btn"
          class="px-4 py-2 bg-purple-400 text-white rounded-full font-bold hover:bg-purple-500 transition-all duration-200 transform hover:scale-105"
          aria-label="ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½ã«ã¤ã„ã¦ã®èª¬æ˜ã‚’è¡¨ç¤º"
        >
          â­ æ³¨æ„äº‹é …
        </button>
        <button
          id="clear-all-btn"
          class="hidden px-4 py-2 bg-red-400 text-white rounded-full font-bold hover:bg-red-500 transition-all duration-200 transform hover:scale-105"
        >
          ğŸ—‘ï¸ å…¨ã¦å‰Šé™¤
        </button>
      </div>
    </div>
  </div>

  <!-- æ¤œç´¢ãƒãƒ¼ & ã‚½ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div class="flex flex-col md:flex-row gap-4 mb-6">
    <div class="flex-1">
      <SearchBar placeholder="ãŠæ°—ã«å…¥ã‚Šã®ã‚»ãƒªãƒ•ã‚’æ¤œç´¢..." />
    </div>
    <SortMenu showFavoriteSort={true} />
  </div>

  <!-- ã‚»ãƒªãƒ•ã‚°ãƒªãƒƒãƒ‰ -->
  <div id="serifu-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- JavaScriptã§å‹•çš„ã«æç”» -->
  </div>

  <!-- ç©ºã®çŠ¶æ…‹ -->
  <div id="empty-state" class="hidden text-center py-16">
    <p class="text-6xl mb-4">ğŸ’”</p>
    <p class="text-xl font-bold text-gray-600 mb-2">
      ãŠæ°—ã«å…¥ã‚ŠãŒã‚ã‚Šã¾ã›ã‚“
    </p>
    <p class="text-gray-400 mb-6">
      ã‚»ãƒªãƒ•ã‚«ãƒ¼ãƒ‰ã® â¤ï¸ ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ã¾ã—ã‚‡ã†
    </p>
    <a 
      href="/kotobako" 
      class="inline-block px-6 py-3 bg-purple-400 text-white rounded-full font-bold hover:bg-purple-500 transition-all duration-200 transform hover:scale-105"
    >
      ã‚»ãƒªãƒ•ã‚’æ¢ã™
    </a>
  </div>
</MainLayout>

<script>
  /**
   * ãŠæ°—ã«å…¥ã‚Šãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–
   */
  import { initializeFavoritesPage } from '../scripts/serifuCard';
  import { getFavoritesData, clearAllFavorites, removeFavorite } from '../utils/favorites';
  import { showToast } from '../utils/toast';
  import type { Serifu, FavoritesData } from '../types';
  
  // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ¸¡ã•ã‚ŒãŸå…¨ã‚»ãƒªãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const allSerifuData = document.getElementById('all-serifu-data');
  if (!allSerifuData) {
    console.error('All serifu data not found');
  } else {
    const allSerifu = JSON.parse(allSerifuData.textContent || '[]') as Array<Serifu & { category: string }>;
    
    // ãŠæ°—ã«å…¥ã‚Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const favoritesData: FavoritesData = getFavoritesData();
    const favoriteIds = Object.keys(favoritesData);
    
    // ãŠæ°—ã«å…¥ã‚Šã‚»ãƒªãƒ•ã‚’æŠ½å‡º
    const favoriteSerifuList = allSerifu
      .filter((serifu) => favoriteIds.includes(serifu.id))
      .map((serifu) => ({
        ...serifu,
        addedAt: favoritesData[serifu.id] || Date.now()
      }));
    
    // ãŠæ°—ã«å…¥ã‚Šãƒšãƒ¼ã‚¸åˆæœŸåŒ–
    initializeFavoritesPage(favoriteSerifuList);
    
    // ãŠæ°—ã«å…¥ã‚Šæ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–ã—ã¦ãƒšãƒ¼ã‚¸ã‚’å†æç”»
    window.addEventListener('favoritesUpdated', () => {
      // æœ€æ–°ã®ãŠæ°—ã«å…¥ã‚Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const updatedFavoritesData: FavoritesData = getFavoritesData();
      const updatedFavoriteIds = Object.keys(updatedFavoritesData);
      
      // ãŠæ°—ã«å…¥ã‚Šã‚»ãƒªãƒ•ã‚’å†æŠ½å‡º
      const updatedFavoriteSerifuList = allSerifu
        .filter((serifu) => updatedFavoriteIds.includes(serifu.id))
        .map((serifu) => ({
          ...serifu,
          addedAt: updatedFavoritesData[serifu.id] || Date.now()
        }));
      
      // ãƒšãƒ¼ã‚¸ã‚’å†åˆæœŸåŒ–
      initializeFavoritesPage(updatedFavoriteSerifuList);
    });
  }
  
  // æ³¨æ„äº‹é …ãƒœã‚¿ãƒ³
  const showNoticeBtn = document.getElementById('show-notice-btn');
  showNoticeBtn?.addEventListener('click', () => {
    const notice = document.getElementById('favorite-notice');
    if (notice) {
      notice.classList.remove('hidden');
      notice.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
  
  // å…¨ã¦å‰Šé™¤ãƒœã‚¿ãƒ³
  const clearAllBtn = document.getElementById('clear-all-btn');
  
  clearAllBtn?.addEventListener('click', () => {
    const favoritesData: FavoritesData = getFavoritesData();
    const count = Object.keys(favoritesData).length;
    
    if (count === 0) return;
    
    if (confirm(`ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ ${count} ä»¶ã®ã‚»ãƒªãƒ•ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
      const serifuList = document.getElementById('serifu-list');
      const allCards = serifuList?.querySelectorAll('[data-text]');
      
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§å‰Šé™¤
      allCards?.forEach((card, index) => {
        setTimeout(() => {
          if (card instanceof HTMLElement) {
            card.style.transition = 'all 0.3s ease';
            card.style.transform = 'scale(0.8)';
            card.style.opacity = '0';
          }
        }, index * 50);
      });
      
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«å‰Šé™¤å®Ÿè¡Œ
      setTimeout(() => {
        clearAllFavorites();
        showToast('ğŸ—‘ï¸', `${count} ä»¶ã®ãŠæ°—ã«å…¥ã‚Šã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, '#ef4444');
        
        // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã›ãšã«çŠ¶æ…‹ã‚’æ›´æ–°
        const emptyState = document.getElementById('empty-state');
        const favoriteCount = document.getElementById('favorite-count');
        
        if (serifuList) serifuList.classList.add('hidden');
        if (emptyState) emptyState.classList.remove('hidden');
        if (clearAllBtn) clearAllBtn.classList.add('hidden');
        if (favoriteCount) favoriteCount.textContent = 'å…¨ 0 ä»¶';
      }, allCards ? allCards.length * 50 + 300 : 300);
    }
  });
</script>

<!-- å…¨ã‚»ãƒªãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’JSONã§åŸ‹ã‚è¾¼ã¿ï¼ˆJavaScriptã‹ã‚‰å‚ç…§ï¼‰ -->
<script type="application/json" id="all-serifu-data" set:html={JSON.stringify(allSerifu)} />