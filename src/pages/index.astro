---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import CategoryNav from "../components/CategoryNav.astro";
import SerifuCard from "../components/SerifuCard.astro";
import SearchBar from "../components/SearchBar.astro";
import FavoriteNotice from "../components/FavoriteNotice.astro";
import categoriesData from "../data/categories.json";

const title = 'ã“ã¨ã°ç®±';
const description = 'ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã‚„é…ä¿¡ã§ä½¿ãˆã‚‹é¢ç™½ã„ã‚»ãƒªãƒ•é›†';

interface Serifu {
  id: string;
  text: string;
  featured: boolean;
  createdAt: string;
}

interface Category {
  id: string;
  name: string;
  icon: string;
  description: string;
  serifu: Serifu[];
}

interface CategoriesData {
  categories: Category[];
}

const data = categoriesData as CategoriesData;

// å…¨ã‚»ãƒªãƒ•ã‚’1ã¤ã®é…åˆ—ã«ã¾ã¨ã‚ã‚‹
const allSerifu = data.categories.flatMap((category) =>
  category.serifu.map((s) => ({
    ...s,
    category: category.id,
  }))
);

// ãƒ©ãƒ³ãƒ€ãƒ ã«è¡¨ç¤ºï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—20ä»¶ã€ã‚¹ãƒãƒ›10ä»¶ï¼‰
const shuffled = [...allSerifu].sort(() => Math.random() - 0.5);
const displaySerifuDesktop = shuffled.slice(0, 20);
const displaySerifuMobile = shuffled.slice(0, 10);
---

<Layout title={title} description={description}>
  <FavoriteNotice />
  <Header />
  
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex gap-8">
      <CategoryNav />
      
      <main class="flex-1 min-w-0">
        <!-- ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ -->
        <nav class="mb-6 text-sm" style="color: #a0aec0;">
          <span style="color: #718096;">ãƒ›ãƒ¼ãƒ </span>
        </nav>

        <div class="mb-8">
          <h1 class="text-3xl font-bold" style="color: #2d3748;">ãƒ©ãƒ³ãƒ€ãƒ ã‚»ãƒªãƒ•</h1>
          <p class="text-sm mt-2" style="color: #a0aec0;">
            ã‚«ãƒ¼ãƒ‰ã‚’é•·æŠ¼ã—ã§ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒšãƒ¼ã‚¸ã¸ç§»å‹•
          </p>
        </div>

        <SearchBar />
        
        <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: 20ä»¶ -->
        <div id="serifu-list" class="hidden lg:grid gap-6 grid-cols-1 lg:grid-cols-2">
          {displaySerifuDesktop.map((serifu) => (
            <div data-category={serifu.category} data-text={serifu.text.toLowerCase()}>
              <SerifuCard
                id={serifu.id}
                text={serifu.text}
                category={serifu.category}
                featured={serifu.featured}
                createdAt={serifu.createdAt}
                showCategoryInId={true}
              />
            </div>
          ))}
        </div>
        
        <!-- ã‚¹ãƒãƒ›: 10ä»¶ -->
        <div id="serifu-list-mobile" class="grid lg:hidden gap-6 grid-cols-1">
          {displaySerifuMobile.map((serifu) => (
            <div data-category={serifu.category} data-text={serifu.text.toLowerCase()}>
              <SerifuCard
                id={serifu.id}
                text={serifu.text}
                category={serifu.category}
                featured={serifu.featured}
                createdAt={serifu.createdAt}
                showCategoryInId={true}
              />
            </div>
          ))}
        </div>
      </main>
    </div>
  </div>
</Layout>

<script>
  let pressTimer: NodeJS.Timeout | null = null;
  let progressInterval: NodeJS.Timeout | null = null;
  let progress = 0;

  // æ¤œç´¢æ©Ÿèƒ½
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const serifuLists = [
    document.getElementById('serifu-list'),
    document.getElementById('serifu-list-mobile')
  ];

  searchInput?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value.toLowerCase();
    
    serifuLists.forEach(list => {
      if (!list) return;
      const items = list.querySelectorAll('[data-text]');
      items.forEach((item) => {
        const text = item.getAttribute('data-text') || '';
        if (text.includes(query)) {
          (item as HTMLElement).style.display = 'block';
        } else {
          (item as HTMLElement).style.display = 'none';
        }
      });
    });
  });

  // é•·æŠ¼ã—æ©Ÿèƒ½
  document.querySelectorAll('[data-id]').forEach((card) => {
    const overlay = card.querySelector('.progress-overlay') as HTMLElement;
    const category = card.getAttribute('data-category');
    const id = card.getAttribute('data-id');

    const startPress = () => {
      progress = 0;
      overlay?.classList.add('active');
      
      progressInterval = setInterval(() => {
        progress += 2;
        if (overlay) {
          overlay.style.background = `linear-gradient(90deg, rgba(167, 139, 250, 0.3) ${progress}%, transparent ${progress}%)`;
        }
        
        if (progress >= 100) {
          clearInterval(progressInterval!);
          window.location.href = `/kotobako/category/${category}#serifu-${id}`;
        }
      }, 20);
    };

    const endPress = () => {
      if (progressInterval) {
        clearInterval(progressInterval);
      }
      progress = 0;
      overlay?.classList.remove('active');
      if (overlay) {
        overlay.style.background = 'linear-gradient(90deg, rgba(167, 139, 250, 0.3) 0%, transparent 0%)';
      }
    };

    card.addEventListener('mousedown', startPress);
    card.addEventListener('touchstart', startPress);
    card.addEventListener('mouseup', endPress);
    card.addEventListener('mouseleave', endPress);
    card.addEventListener('touchend', endPress);
    card.addEventListener('touchcancel', endPress);
  });

  // ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³
  document.querySelectorAll('.favorite-btn').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const id = btn.getAttribute('data-serifu-id');
      // TODO: ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½å®Ÿè£…
      alert('ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ã¾ã—ãŸï¼(å®Ÿè£…äºˆå®š)');
    });
  });

  // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
  document.querySelectorAll('.copy-btn').forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const id = btn.getAttribute('data-serifu-id');
      const category = btn.closest('[data-category]')?.getAttribute('data-category');
      const url = `${window.location.origin}/kotobako/category/${category}#serifu-${id}`;
      
      try {
        await navigator.clipboard.writeText(url);
        btn.textContent = 'âœ…';
        setTimeout(() => {
          btn.textContent = 'ğŸ”—';
        }, 2000);
      } catch (err) {
        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });
  });
</script>