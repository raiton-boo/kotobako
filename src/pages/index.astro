---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import CategoryNav from '../components/CategoryNav.astro';
import SearchBar from '../components/SearchBar.astro';
import SortMenu from '../components/SortMenu.astro';
import SerifuCard from '../components/SerifuCard.astro';
import FavoriteNotice from '../components/FavoriteNotice.astro';
import Footer from '../components/Footer.astro';
import categoriesData from '../data/categories.json';

const title = 'ã“ã¨ã°ç®± | ã‚»ãƒªãƒ•ãƒ»ä¸€è¨€ã‚¹ãƒˆãƒƒã‚¯ã‚µã‚¤ãƒˆ';
const description = 'ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã‚„é…ä¿¡ã§ä½¿ãˆã‚‹é¢ç™½ã„ã‚»ãƒªãƒ•é›†';

interface Serifu {
  id: string;
  text: string;
  featured: boolean;
  createdAt: string;
}

interface Category {
  id: string;
  name: string;
  icon: string;
  description: string;
  serifu: Serifu[];
}

interface CategoriesData {
  categories: Category[];
}

const data = categoriesData as CategoriesData;

// å…¨ã‚»ãƒªãƒ•ã‚’1ã¤ã®é…åˆ—ã«ã¾ã¨ã‚ã‚‹
const allSerifu = data.categories.flatMap((category) =>
  category.serifu.map((s) => ({
    ...s,
    category: category.id,
  }))
);

// ãƒ©ãƒ³ãƒ€ãƒ ã«10å€‹é¸ã¶ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã¯ä½¿ã‚ãªã„ï¼‰
const randomSerifu = allSerifu.slice(0, 10);
---

<Layout title={title} description={description}>
  <FavoriteNotice />
  <Header />
  
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex gap-8">
      <CategoryNav />
      
      <main class="flex-1 min-w-0">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-800 mb-2">
            ğŸ“¦ ã“ã¨ã°ç®±
          </h1>
          <p class="text-lg text-gray-600">
            ã‚»ãƒªãƒ•ãƒ»ä¸€è¨€ã‚’ã‚¹ãƒˆãƒƒã‚¯ã™ã‚‹ã‚µã‚¤ãƒˆ
          </p>
        </div>

        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <div class="flex-1">
            <SearchBar />
          </div>
          <SortMenu />
        </div>

        <div id="serifu-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
        </div>
      </main>
    </div>
  </div>
  
  <Footer />
</Layout>

<script define:vars={{ allSerifu }} is:inline>
  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ãƒ©ãƒ³ãƒ€ãƒ ã«10å€‹é¸ã¶
  const shuffled = [...allSerifu].sort(() => Math.random() - 0.5);
  const randomSerifu = shuffled.slice(0, 10);
  
  const serifuList = document.getElementById('serifu-list');
  const searchInput = document.getElementById('search-input');
  const sortSelect = document.getElementById('sort-select');
  
  let currentSerifu = randomSerifu;

  function renderCards(serifuArray) {
    if (!serifuList) return;
    serifuList.innerHTML = '';
    
    serifuArray.forEach((serifu) => {
      const wrapper = document.createElement('div');
      wrapper.setAttribute('data-text', serifu.text.toLowerCase());
      wrapper.setAttribute('data-date', serifu.createdAt);
      wrapper.setAttribute('data-featured', String(serifu.featured));
      
      const categoryNames = {
        'batsu-game': 'ç½°ã‚²ãƒ¼ãƒ ',
        'kokuhaku': 'å‘Šç™½',
        'haishin': 'é…ä¿¡',
        'chuunibyou': 'å¨äºŒç—…'
      };
      const categoryName = categoryNames[serifu.category] || serifu.category;
      const displayId = `${categoryName} No.${serifu.id.split('-').pop()}`;
      const formattedDate = serifu.createdAt.replace(/-/g, '/');

      wrapper.innerHTML = `
        <div 
          id="serifu-${serifu.id}"
          class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all duration-300 p-8 relative transform hover:-translate-y-1 cursor-pointer select-none overflow-hidden"
          data-id="${serifu.id}"
          data-category="${serifu.category}"
          style="height: 280px;"
        >
          <div class="progress-overlay"></div>
          
          ${serifu.featured ? `
            <span class="absolute top-4 right-4 bg-yellow-400 text-yellow-900 text-xs px-3 py-1 rounded-full font-bold pointer-events-none" style="z-index: 2;">
              â­ ãŠã™ã™ã‚
            </span>
          ` : ''}
          
          <div class="absolute inset-0 flex items-center justify-center p-8" style="padding-bottom: 80px; z-index: 2;">
            <p class="font-serifu text-3xl md:text-4xl text-center leading-relaxed text-gray-800 select-text cursor-text pointer-events-auto">
              ${serifu.text}
            </p>
          </div>
          
          <div class="absolute bottom-0 left-0 right-0 flex justify-between items-center p-8 pt-4 border-t border-gray-200 pointer-events-none" style="z-index: 2;">
            <div class="flex flex-col gap-1">
              <span class="text-sm font-bold text-gray-400">
                ${displayId}
              </span>
              <span class="text-xs text-gray-400">
                Created at ${formattedDate}
              </span>
            </div>
            
            <div class="flex gap-2 pointer-events-auto">
              <button
                class="favorite-btn p-2 rounded-full hover:bg-gray-100 transition-all duration-200"
                aria-label="ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ "
                data-serifu-id="${serifu.id}"
              >
                â¤ï¸
              </button>
              
              <button
                class="copy-btn p-2 rounded-full hover:bg-gray-100 transition-all duration-200"
                aria-label="ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼"
                data-serifu-id="${serifu.id}"
              >
                ğŸ”—
              </button>
            </div>
          </div>
        </div>
      `;
      
      serifuList.appendChild(wrapper);
    });
    
    setupLongPress();
    setupButtons();
  }

  // åˆæœŸè¡¨ç¤º
  renderCards(currentSerifu);

  // æ¤œç´¢æ©Ÿèƒ½
  searchInput?.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    const items = serifuList?.querySelectorAll('[data-text]');
    
    items?.forEach((item) => {
      const text = item.getAttribute('data-text') || '';
      item.style.display = text.includes(query) ? 'block' : 'none';
    });
  });

  // ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
  sortSelect?.addEventListener('change', (e) => {
    const sortType = e.target.value;
    const items = Array.from(serifuList?.querySelectorAll('[data-date]') || []);
    
    items.sort((a, b) => {
      if (sortType === 'newest') {
        return (b.getAttribute('data-date') || '').localeCompare(a.getAttribute('data-date') || '');
      } else if (sortType === 'oldest') {
        return (a.getAttribute('data-date') || '').localeCompare(b.getAttribute('data-date') || '');
      } else if (sortType === 'featured') {
        const aFeatured = a.getAttribute('data-featured') === 'true' ? 1 : 0;
        const bFeatured = b.getAttribute('data-featured') === 'true' ? 1 : 0;
        return bFeatured - aFeatured;
      }
      return 0;
    });
    
    items.forEach(item => serifuList?.appendChild(item));
  });

  // é•·æŠ¼ã—æ©Ÿèƒ½
  let progressInterval = null;
  let progress = 0;

  function setupLongPress() {
    const cards = document.querySelectorAll('[data-id]');
    
    cards.forEach((card) => {
      const overlay = card.querySelector('.progress-overlay');
      const category = card.getAttribute('data-category');
      const id = card.getAttribute('data-id');

      const startPress = (e) => {
        if (e.target.closest('button')) return;
        
        progress = 0;
        overlay?.classList.add('active');
        
        progressInterval = setInterval(() => {
          progress += 2;
          if (overlay) {
            overlay.style.background = `linear-gradient(90deg, rgba(167, 139, 250, 0.3) ${progress}%, transparent ${progress}%)`;
          }
          
          if (progress >= 100) {
            clearInterval(progressInterval);
            sessionStorage.setItem('scrollToSerifu', id);
            window.location.href = `/kotobako/category/${category}#serifu-${id}`;
          }
        }, 20);
      };

      const endPress = () => {
        if (progressInterval) clearInterval(progressInterval);
        progress = 0;
        overlay?.classList.remove('active');
        if (overlay) {
          overlay.style.background = 'linear-gradient(90deg, rgba(167, 139, 250, 0.3) 0%, transparent 0%)';
        }
      };

      card.addEventListener('mousedown', startPress);
      card.addEventListener('touchstart', startPress);
      card.addEventListener('mouseup', endPress);
      card.addEventListener('mouseleave', endPress);
      card.addEventListener('touchend', endPress);
      card.addEventListener('touchcancel', endPress);
    });
  }

  function setupButtons() {
    // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
    function showToast(icon, message, color) {
      const container = document.getElementById('toast-container');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = 'toast-item';
      toast.style.backgroundColor = color;
      toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;

      container.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 2000);
    }

    // ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³
    document.querySelectorAll('.favorite-btn').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const id = btn.getAttribute('data-serifu-id');
        
        const favoritesData = JSON.parse(localStorage.getItem('favoritesData') || '{}');
        
        if (favoritesData[id]) {
          delete favoritesData[id];
          btn.textContent = 'â¤ï¸';
          showToast('ğŸ’”', 'ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ', '#ef4444');
        } else {
          favoritesData[id] = Date.now();
          btn.textContent = 'ğŸ’–';
          showToast('ğŸ’–', 'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ã¾ã—ãŸ', '#a855f7');
        }
        
        localStorage.setItem('favoritesData', JSON.stringify(favoritesData));
        localStorage.setItem('favorites', JSON.stringify(Object.keys(favoritesData)));
      });
    });

    // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
    document.querySelectorAll('.copy-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const id = btn.getAttribute('data-serifu-id');
        const card = btn.closest('[data-category]');
        const category = card?.getAttribute('data-category');
        const url = `${window.location.origin}/kotobako/category/${category}#serifu-${id}`;
        
        try {
          await navigator.clipboard.writeText(url);
          btn.textContent = 'âœ…';
          showToast('ğŸ”—', 'ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', '#10b981');
          setTimeout(() => btn.textContent = 'ğŸ”—', 2000);
        } catch (err) {
          alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      });
    });

    // ãŠæ°—ã«å…¥ã‚ŠçŠ¶æ…‹ã‚’å¾©å…ƒ
    const storedFavorites = JSON.parse(localStorage.getItem('favoritesData') || '{}');
    document.querySelectorAll('.favorite-btn').forEach((btn) => {
      const id = btn.getAttribute('data-serifu-id');
      if (storedFavorites[id]) {
        btn.textContent = 'ğŸ’–';
      }
    });
  }
</script>

<style is:global>
  .progress-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, rgba(167, 139, 250, 0.3) 0%, transparent 0%);
    border-radius: 1rem;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
    z-index: 1;
  }

  .progress-overlay.active {
    opacity: 1;
  }
</style>