---
// filepath: src/pages/index.astro
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import CategoryNav from "../components/CategoryNav.astro";
import SerifuCard from "../components/SerifuCard.astro";
import SearchBar from "../components/SearchBar.astro";
import FavoriteNotice from "../components/FavoriteNotice.astro";
import Footer from "../components/Footer.astro";
import categoriesData from "../data/categories.json";

const title = 'ã“ã¨ã°ç®±';
const description = 'ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã‚„é…ä¿¡ã§ä½¿ãˆã‚‹é¢ç™½ã„ã‚»ãƒªãƒ•é›†';

interface Serifu {
  id: string;
  text: string;
  featured: boolean;
  createdAt: string;
}

interface Category {
  id: string;
  name: string;
  icon: string;
  description: string;
  serifu: Serifu[];
}

interface CategoriesData {
  categories: Category[];
}

const data = categoriesData as CategoriesData;

// å…¨ã‚»ãƒªãƒ•ã‚’1ã¤ã®é…åˆ—ã«ã¾ã¨ã‚ã‚‹
const allSerifu = data.categories.flatMap((category) =>
  category.serifu.map((s) => ({
    ...s,
    category: category.id,
  }))
);

// ãƒ©ãƒ³ãƒ€ãƒ ã«è¡¨ç¤ºï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—20ä»¶ã€ã‚¹ãƒãƒ›10ä»¶ï¼‰
const shuffled = [...allSerifu].sort(() => Math.random() - 0.5);
const displaySerifuDesktop = shuffled.slice(0, 20);
const displaySerifuMobile = shuffled.slice(0, 10);
---

<Layout title={title} description={description}>
  <FavoriteNotice />
  <Header />
  
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex gap-8">
      <CategoryNav />
      
      <main class="flex-1 min-w-0">
        <!-- ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ -->
        <nav class="mb-6 text-sm text-gray-400">
          <span class="text-gray-600">ãƒ›ãƒ¼ãƒ </span>
        </nav>

        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-800">
            ãƒ©ãƒ³ãƒ€ãƒ ã‚»ãƒªãƒ•
          </h1>
          <p class="text-sm mt-2 text-gray-400">
            ã‚«ãƒ¼ãƒ‰ã‚’é•·æŠ¼ã—ã§ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒšãƒ¼ã‚¸ã¸ç§»å‹•
          </p>
        </div>

        <SearchBar />

        <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: 20ä»¶ -->
        <div id="serifu-list" class="hidden lg:grid gap-6 grid-cols-1 lg:grid-cols-2">
          {displaySerifuDesktop.map((serifu) => (
            <div 
              data-category={serifu.category} 
              data-text={serifu.text.toLowerCase()}
              data-date={serifu.createdAt}
              data-featured={serifu.featured}
            >
              <SerifuCard
                id={serifu.id}
                text={serifu.text}
                category={serifu.category}
                featured={serifu.featured}
                createdAt={serifu.createdAt}
                showCategoryInId={true}
              />
            </div>
          ))}
        </div>
        
        <!-- ã‚¹ãƒãƒ›: 10ä»¶ -->
        <div id="serifu-list-mobile" class="grid lg:hidden gap-6 grid-cols-1">
          {displaySerifuMobile.map((serifu) => (
            <div 
              data-category={serifu.category} 
              data-text={serifu.text.toLowerCase()}
              data-date={serifu.createdAt}
              data-featured={serifu.featured}
            >
              <SerifuCard
                id={serifu.id}
                text={serifu.text}
                category={serifu.category}
                featured={serifu.featured}
                createdAt={serifu.createdAt}
                showCategoryInId={true}
              />
            </div>
          ))}
        </div>
      </main>
    </div>
  </div>
  
  <Footer />
</Layout>


<script>
  let pressTimer: NodeJS.Timeout | null = null;
  let progressInterval: NodeJS.Timeout | null = null;
  let progress = 0;
  let toastCount = 0;

  // æ¤œç´¢æ©Ÿèƒ½
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const serifuLists = [
    document.getElementById('serifu-list'),
    document.getElementById('serifu-list-mobile')
  ];

  searchInput?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value.toLowerCase();
    
    serifuLists.forEach(list => {
      if (!list) return;
      const items = list.querySelectorAll('[data-text]');
      items.forEach((item) => {
        const text = item.getAttribute('data-text') || '';
        if (text.includes(query)) {
          (item as HTMLElement).style.display = 'block';
        } else {
          (item as HTMLElement).style.display = 'none';
        }
      });
    });
  });

  // ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
  const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
  
  sortSelect?.addEventListener('change', (e) => {
    const sortType = (e.target as HTMLSelectElement).value;
    
    serifuLists.forEach(list => {
      if (!list) return;
      const items = Array.from(list.querySelectorAll('[data-date]')) as HTMLElement[];
      
      items.sort((a, b) => {
        if (sortType === 'newest') {
          return (b.getAttribute('data-date') || '').localeCompare(a.getAttribute('data-date') || '');
        } else if (sortType === 'oldest') {
          return (a.getAttribute('data-date') || '').localeCompare(b.getAttribute('data-date') || '');
        } else if (sortType === 'featured') {
          const aFeatured = a.getAttribute('data-featured') === 'true' ? 1 : 0;
          const bFeatured = b.getAttribute('data-featured') === 'true' ? 1 : 0;
          return bFeatured - aFeatured;
        }
        return 0;
      });
      
      items.forEach(item => list.appendChild(item));
    });
  });

  // é•·æŠ¼ã—æ©Ÿèƒ½
  document.querySelectorAll('[data-id]').forEach((card) => {
    const overlay = card.querySelector('.progress-overlay') as HTMLElement;
    const category = card.getAttribute('data-category');
    const id = card.getAttribute('data-id');

    const startPress = (e: Event) => {
      if ((e.target as HTMLElement).closest('button')) {
        return;
      }
      
      progress = 0;
      overlay?.classList.add('active');
      
      progressInterval = setInterval(() => {
        progress += 2;
        if (overlay) {
          overlay.style.background = `linear-gradient(90deg, rgba(167, 139, 250, 0.3) ${progress}%, transparent ${progress}%)`;
        }
        
        if (progress >= 100) {
          clearInterval(progressInterval!);
          window.location.href = `/kotobako/category/${category}#serifu-${id}`;
        }
      }, 20);
    };

    const endPress = () => {
      if (progressInterval) {
        clearInterval(progressInterval);
      }
      progress = 0;
      overlay?.classList.remove('active');
      if (overlay) {
        overlay.style.background = 'linear-gradient(90deg, rgba(167, 139, 250, 0.3) 0%, transparent 0%)';
      }
    };

    card.addEventListener('mousedown', startPress);
    card.addEventListener('touchstart', startPress);
    card.addEventListener('mouseup', endPress);
    card.addEventListener('mouseleave', endPress);
    card.addEventListener('touchend', endPress);
    card.addEventListener('touchcancel', endPress);
  });

  // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºé–¢æ•°ï¼ˆæœ€å¤§3ä»¶ã¾ã§ã€å³åº§ã«å‰Šé™¤ï¼‰
  function showToast(icon: string, message: string, color: string) {
    const container = document.getElementById('toast-container');
    if (!container) return;

    // æ—¢å­˜ã®ãƒˆãƒ¼ã‚¹ãƒˆãŒ3ä»¶ä»¥ä¸Šãªã‚‰å¤ã„ã‚‚ã®ã‚’å³åº§ã«å‰Šé™¤
    const existingToasts = container.querySelectorAll('.toast-item');
    if (existingToasts.length >= 3) {
      const oldestToast = existingToasts[0];
      oldestToast.classList.remove('show');
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ã‚’å¾…ãŸãšã«ã™ãå‰Šé™¤
      setTimeout(() => {
        oldestToast.remove();
      }, 100);
    }

    // æ–°ã—ã„ãƒˆãƒ¼ã‚¹ãƒˆã‚’ä½œæˆ
    const toast = document.createElement('div');
    toast.className = 'toast-item';
    toast.style.backgroundColor = color;
    toast.innerHTML = `
      <span class="toast-icon">${icon}</span>
      <span>${message}</span>
    `;

    container.appendChild(toast);

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    setTimeout(() => {
      toast.classList.add('show');
    }, 10);

    // 2ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 2000);
  }

  // ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³
  document.querySelectorAll('.favorite-btn').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const id = btn.getAttribute('data-serifu-id');
      
      const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      const index = favorites.indexOf(id);
      
      if (index > -1) {
        favorites.splice(index, 1);
        btn.textContent = 'â¤ï¸';
        showToast('ğŸ’”', 'ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ', '#ef4444');
      } else {
        favorites.push(id);
        btn.textContent = 'ğŸ’–';
        showToast('ğŸ’–', 'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ã¾ã—ãŸ', '#a855f7');
      }
      
      localStorage.setItem('favorites', JSON.stringify(favorites));
    });
  });

  // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
  document.querySelectorAll('.copy-btn').forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const id = btn.getAttribute('data-serifu-id');
      const category = btn.closest('[data-category]')?.getAttribute('data-category');
      const url = `${window.location.origin}/kotobako/category/${category}#serifu-${id}`;
      
      try {
        await navigator.clipboard.writeText(url);
        btn.textContent = 'âœ…';
        showToast('ğŸ”—', 'ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', '#10b981');
        setTimeout(() => {
          btn.textContent = 'ğŸ”—';
        }, 2000);
      } catch (err) {
        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });
  });

  // ãŠæ°—ã«å…¥ã‚ŠçŠ¶æ…‹ã‚’å¾©å…ƒ
  const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
  document.querySelectorAll('.favorite-btn').forEach((btn) => {
    const id = btn.getAttribute('data-serifu-id');
    if (favorites.includes(id)) {
      btn.textContent = 'ğŸ’–';
    }
  });
</script>