---
// filepath: src/pages/category/[slug].astro
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import CategoryNav from '../../components/CategoryNav.astro';
import SerifuCard from '../../components/SerifuCard.astro';
import SearchBar from '../../components/SearchBar.astro';
import SortMenu from '../../components/SortMenu.astro';
import FavoriteNotice from '../../components/FavoriteNotice.astro';
import Footer from '../../components/Footer.astro';
import categoriesData from '../../data/categories.json';

export function getStaticPaths() {
  const data = categoriesData as {
    categories: Array<{
      id: string;
      name: string;
      icon: string;
      description: string;
      serifu: Array<{
        id: string;
        text: string;
        featured: boolean;
        createdAt: string;
      }>;
    }>;
  };

  return data.categories.map((category) => ({
    params: { slug: category.id },
    props: { category },
  }));
}

const { category } = Astro.props;
const title = `${category.name} | „Åì„Å®„Å∞ÁÆ±`;
const description = category.description;
---

<Layout title={title} description={description}>
  <FavoriteNotice />
  <Header />
  
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex gap-8">
      <CategoryNav />
      
      <main class="flex-1 min-w-0">
        <!-- „Éë„É≥„Åè„Åö„É™„Çπ„Éà -->
        <nav class="mb-6 text-sm text-gray-400">
          <a href="/kotobako" class="hover:underline text-gray-600">„Éõ„Éº„É†</a>
          <span class="mx-2">/</span>
          <span class="text-gray-600">{category.icon} {category.name}</span>
        </nav>

        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-800 mb-2">
            {category.icon} {category.name}
          </h1>
          <p class="text-lg text-gray-600">
            {category.description}
          </p>
          <p class="text-sm mt-2 text-gray-400">
            ÂÖ® {category.serifu.length} ‰ª∂
          </p>
        </div>

        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <div class="flex-1">
            <SearchBar categoryName={category.name} />
          </div>
          <SortMenu />
        </div>

        <div id="serifu-list" class="grid gap-6 grid-cols-1 lg:grid-cols-2">
          {category.serifu.map((serifu) => (
            <div 
              data-text={serifu.text.toLowerCase()}
              data-date={serifu.createdAt}
              data-featured={serifu.featured}
            >
              <SerifuCard
                id={serifu.id}
                text={serifu.text}
                category={category.id}
                featured={serifu.featured}
                createdAt={serifu.createdAt}
              />
            </div>
          ))}
        </div>
      </main>
    </div>
  </div>
  
  <Footer />
</Layout>


<script>
  let pressTimer: NodeJS.Timeout | null = null;
  let progressInterval: NodeJS.Timeout | null = null;
  let progress = 0;

  // Ê§úÁ¥¢Ê©üËÉΩ
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const serifuLists = [
    document.getElementById('serifu-list'),
    document.getElementById('serifu-list-mobile')
  ];

  searchInput?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value.toLowerCase();
    
    serifuLists.forEach(list => {
      if (!list) return;
      const items = list.querySelectorAll('[data-text]');
      items.forEach((item) => {
        const text = item.getAttribute('data-text') || '';
        if (text.includes(query)) {
          (item as HTMLElement).style.display = 'block';
        } else {
          (item as HTMLElement).style.display = 'none';
        }
      });
    });
  });

  // „ÇΩ„Éº„ÉàÊ©üËÉΩ
  const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
  
  sortSelect?.addEventListener('change', (e) => {
    const sortType = (e.target as HTMLSelectElement).value;
    
    serifuLists.forEach(list => {
      if (!list) return;
      const items = Array.from(list.querySelectorAll('[data-date]')) as HTMLElement[];
      
      items.sort((a, b) => {
        if (sortType === 'newest') {
          return (b.getAttribute('data-date') || '').localeCompare(a.getAttribute('data-date') || '');
        } else if (sortType === 'oldest') {
          return (a.getAttribute('data-date') || '').localeCompare(b.getAttribute('data-date') || '');
        } else if (sortType === 'featured') {
          const aFeatured = a.getAttribute('data-featured') === 'true' ? 1 : 0;
          const bFeatured = b.getAttribute('data-featured') === 'true' ? 1 : 0;
          return bFeatured - aFeatured;
        }
        return 0;
      });
      
      items.forEach(item => list.appendChild(item));
    });
  });

  // Èï∑Êäº„ÅóÊ©üËÉΩ
  document.querySelectorAll('[data-id]').forEach((card) => {
    const overlay = card.querySelector('.progress-overlay') as HTMLElement;
    const category = card.getAttribute('data-category');
    const id = card.getAttribute('data-id');

    const startPress = (e: Event) => {
      // „Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅØÈï∑Êäº„Åó„ÇíÁô∫ÁÅ´„Åó„Å™„ÅÑ
      if ((e.target as HTMLElement).closest('button')) {
        return;
      }
      
      progress = 0;
      overlay?.classList.add('active');
      
      progressInterval = setInterval(() => {
        progress += 2;
        if (overlay) {
          overlay.style.background = `linear-gradient(90deg, rgba(167, 139, 250, 0.3) ${progress}%, transparent ${progress}%)`;
        }
        
        if (progress >= 100) {
          clearInterval(progressInterval!);
          window.location.href = `/kotobako/category/${category}#serifu-${id}`;
        }
      }, 20);
    };

    const endPress = () => {
      if (progressInterval) {
        clearInterval(progressInterval);
      }
      progress = 0;
      overlay?.classList.remove('active');
      if (overlay) {
        overlay.style.background = 'linear-gradient(90deg, rgba(167, 139, 250, 0.3) 0%, transparent 0%)';
      }
    };

    card.addEventListener('mousedown', startPress);
    card.addEventListener('touchstart', startPress);
    card.addEventListener('mouseup', endPress);
    card.addEventListener('mouseleave', endPress);
    card.addEventListener('touchend', endPress);
    card.addEventListener('touchcancel', endPress);
  });

  // „Éà„Éº„Çπ„ÉàË°®Á§∫Èñ¢Êï∞
  function showToast(icon: string, message: string, color: string) {
    const toast = document.getElementById('favorite-toast');
    const toastIcon = document.getElementById('toast-icon');
    const toastMessage = document.getElementById('toast-message');
    
    if (toastIcon && toastMessage && toast) {
      toastIcon.textContent = icon;
      toastMessage.textContent = message;
      toast.classList.add('show');
      toast.style.backgroundColor = color;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }
  }

  // „ÅäÊ∞ó„Å´ÂÖ•„Çä„Éú„Çø„É≥
  document.querySelectorAll('.favorite-btn').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const id = btn.getAttribute('data-serifu-id');
      
      const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      const index = favorites.indexOf(id);
      
      if (index > -1) {
        favorites.splice(index, 1);
        btn.textContent = '‚ù§Ô∏è';
        showToast('üíî', '„ÅäÊ∞ó„Å´ÂÖ•„Çä„Åã„ÇâÂâäÈô§„Åó„Åæ„Åó„Åü', '#ef4444');
      } else {
        favorites.push(id);
        btn.textContent = 'üíñ';
        showToast('üíñ', '„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü', '#a855f7');
      }
      
      localStorage.setItem('favorites', JSON.stringify(favorites));
    });
  });

  // „Ç≥„Éî„Éº„Éú„Çø„É≥
  document.querySelectorAll('.copy-btn').forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const id = btn.getAttribute('data-serifu-id');
      const category = btn.closest('[data-category]')?.getAttribute('data-category');
      const url = `${window.location.origin}/kotobako/category/${category}#serifu-${id}`;
      
      try {
        await navigator.clipboard.writeText(url);
        btn.textContent = '‚úÖ';
        showToast('üîó', '„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', '#10b981');
        setTimeout(() => {
          btn.textContent = 'üîó';
        }, 2000);
      } catch (err) {
        alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
    });
  });

  // „ÅäÊ∞ó„Å´ÂÖ•„ÇäÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
  const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
  document.querySelectorAll('.favorite-btn').forEach((btn) => {
    const id = btn.getAttribute('data-serifu-id');
    if (favorites.includes(id)) {
      btn.textContent = 'üíñ';
    }
  });
</script>