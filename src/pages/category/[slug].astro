---
// filepath: src/pages/category/[slug].astro
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import CategoryNav from '../../components/CategoryNav.astro';
import SerifuCard from '../../components/SerifuCard.astro';
import SearchBar from '../../components/SearchBar.astro';
import SortMenu from '../../components/SortMenu.astro';
import FavoriteNotice from '../../components/FavoriteNotice.astro';
import Footer from '../../components/Footer.astro';
import categoriesData from '../../data/categories.json';

export function getStaticPaths() {
  const data = categoriesData as {
    categories: Array<{
      id: string;
      name: string;
      icon: string;
      description: string;
      serifu: Array<{
        id: string;
        text: string;
        featured: boolean;
        createdAt: string;
      }>;
    }>;
  };

  return data.categories.map((category) => ({
    params: { slug: category.id },
    props: { category },
  }));
}

const { category } = Astro.props;
const title = `${category.name} | „Åì„Å®„Å∞ÁÆ±`;
const description = category.description;
---

<Layout title={title} description={description}>
  <FavoriteNotice />
  <Header />
  
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex gap-8">
      <CategoryNav />
      
      <main class="flex-1 min-w-0">
        <!-- „Éë„É≥„Åè„Åö„É™„Çπ„Éà -->
        <nav class="mb-6 text-sm text-gray-400">
          <a href="/kotobako" class="hover:underline text-gray-600">„Éõ„Éº„É†</a>
          <span class="mx-2">/</span>
          <span class="text-gray-600">{category.icon} {category.name}</span>
        </nav>

        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-800 mb-2">
            {category.icon} {category.name}
          </h1>
          <p class="text-lg text-gray-600">
            {category.description}
          </p>
          <p class="text-sm mt-2 text-gray-400">
            ÂÖ® {category.serifu.length} ‰ª∂
          </p>
        </div>

        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <div class="flex-1">
            <SearchBar categoryName={category.name} />
          </div>
          <SortMenu />
        </div>

        <div id="serifu-list" class="grid gap-6 grid-cols-1 lg:grid-cols-2">
          {category.serifu.map((serifu) => (
            <div 
              data-text={serifu.text.toLowerCase()}
              data-date={serifu.createdAt}
              data-featured={serifu.featured}
            >
              <SerifuCard
                id={serifu.id}
                text={serifu.text}
                category={category.id}
                featured={serifu.featured}
                createdAt={serifu.createdAt}
              />
            </div>
          ))}
        </div>
      </main>
    </div>
  </div>
  
  <Footer />
</Layout>


<script>
  // Ê§úÁ¥¢Ê©üËÉΩ
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const serifuList = document.getElementById('serifu-list');

  searchInput?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value.toLowerCase();
    const items = serifuList?.querySelectorAll('[data-text]');
    
    items?.forEach((item) => {
      const text = item.getAttribute('data-text') || '';
      if (text.includes(query)) {
        (item as HTMLElement).style.display = 'block';
      } else {
        (item as HTMLElement).style.display = 'none';
      }
    });
  });

  // „ÇΩ„Éº„ÉàÊ©üËÉΩ
  const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
  
  sortSelect?.addEventListener('change', (e) => {
    const sortType = (e.target as HTMLSelectElement).value;
    const items = Array.from(serifuList?.querySelectorAll('[data-date]') || []) as HTMLElement[];
    
    items.sort((a, b) => {
      if (sortType === 'newest') {
        return (b.getAttribute('data-date') || '').localeCompare(a.getAttribute('data-date') || '');
      } else if (sortType === 'oldest') {
        return (a.getAttribute('data-date') || '').localeCompare(b.getAttribute('data-date') || '');
      } else if (sortType === 'featured') {
        const aFeatured = a.getAttribute('data-featured') === 'true' ? 1 : 0;
        const bFeatured = b.getAttribute('data-featured') === 'true' ? 1 : 0;
        return bFeatured - aFeatured;
      }
      return 0;
    });
    
    items.forEach(item => serifuList?.appendChild(item));
  });

  // „Éà„Éº„Çπ„ÉàË°®Á§∫Èñ¢Êï∞ÔºàÊúÄÂ§ß3‰ª∂„Åæ„Åß„ÄÅÂç≥Â∫ß„Å´ÂâäÈô§Ôºâ
  function showToast(icon: string, message: string, color: string) {
    const container = document.getElementById('toast-container');
    if (!container) return;

    // Êó¢Â≠ò„ÅÆ„Éà„Éº„Çπ„Éà„Åå3‰ª∂‰ª•‰∏ä„Å™„ÇâÂè§„ÅÑ„ÇÇ„ÅÆ„ÇíÂç≥Â∫ß„Å´ÂâäÈô§
    const existingToasts = container.querySelectorAll('.toast-item');
    if (existingToasts.length >= 3) {
      const oldestToast = existingToasts[0];
      oldestToast.classList.remove('show');
      // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫Ü„ÇíÂæÖ„Åü„Åö„Å´„Åô„ÅêÂâäÈô§
      setTimeout(() => {
        oldestToast.remove();
      }, 100);
    }

    // Êñ∞„Åó„ÅÑ„Éà„Éº„Çπ„Éà„Çí‰ΩúÊàê
    const toast = document.createElement('div');
    toast.className = 'toast-item';
    toast.style.backgroundColor = color;
    toast.innerHTML = `
      <span class="toast-icon">${icon}</span>
      <span>${message}</span>
    `;

    container.appendChild(toast);

    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
    setTimeout(() => {
      toast.classList.add('show');
    }, 10);

    // 2ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 2000);
  }

  // „ÅäÊ∞ó„Å´ÂÖ•„Çä„Éú„Çø„É≥
  document.querySelectorAll('.favorite-btn').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const id = btn.getAttribute('data-serifu-id');
      
      const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      const index = favorites.indexOf(id);
      
      if (index > -1) {
        favorites.splice(index, 1);
        btn.textContent = '‚ù§Ô∏è';
        showToast('üíî', '„ÅäÊ∞ó„Å´ÂÖ•„Çä„Åã„ÇâÂâäÈô§„Åó„Åæ„Åó„Åü', '#ef4444');
      } else {
        favorites.push(id);
        btn.textContent = 'üíñ';
        showToast('üíñ', '„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü', '#a855f7');
      }
      
      localStorage.setItem('favorites', JSON.stringify(favorites));
    });
  });

  // „Ç≥„Éî„Éº„Éú„Çø„É≥
  document.querySelectorAll('.copy-btn').forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const id = btn.getAttribute('data-serifu-id');
      const url = `${window.location.href.split('#')[0]}#serifu-${id}`;
      
      try {
        await navigator.clipboard.writeText(url);
        btn.textContent = '‚úÖ';
        showToast('üîó', '„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', '#10b981');
        setTimeout(() => {
          btn.textContent = 'üîó';
        }, 2000);
      } catch (err) {
        alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
    });
  });

  // „ÅäÊ∞ó„Å´ÂÖ•„ÇäÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
  const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
  document.querySelectorAll('.favorite-btn').forEach((btn) => {
    const id = btn.getAttribute('data-serifu-id');
    if (favorites.includes(id)) {
      btn.textContent = 'üíñ';
    }
  });

  // URL„Éè„ÉÉ„Ç∑„É•„ÅßÊåáÂÆö„Åï„Çå„Åü„Çª„É™„Éï„Å´„Çπ„ÇØ„É≠„Éº„É´ & „Éè„Ç§„É©„Ç§„Éà
  if (window.location.hash) {
    const targetId = window.location.hash.substring(1);
    const targetElement = document.getElementById(targetId);
    if (targetElement) {
      setTimeout(() => {
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // „Éè„Ç§„É©„Ç§„Éà„Ç®„Éï„Çß„ÇØ„Éà
        targetElement.style.transition = 'all 0.3s ease';
        targetElement.style.transform = 'scale(1.05)';
        targetElement.style.boxShadow = '0 0 0 4px rgba(167, 139, 250, 0.5)';
        
        setTimeout(() => {
          targetElement.style.transform = 'scale(1)';
          targetElement.style.boxShadow = '';
        }, 2000);
      }, 100);
    }
  }
</script>